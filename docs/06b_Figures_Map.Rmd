---
title: "05b_Figures_Map"
author: J Andres Gannon, Erik Gartzke, and Jon Lindsay, Center for Peace and Security
  Studies (cPASS)
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    code_download: true
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: '5'
    toc_float:
      collapsed: yes
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document visualizes the geographic relationship between deterrence and the severity of Russian cyber operations.

Research assistance for this rmd provided by Cole Reynolds.

# Preparation
## Load packages
Pipe operators have trouble loading for individual commands
```{r}
library(magrittr)
library(ggplot2)
```

## Load data
Load the cleaned and subset versions of each dataset
```{r}
# Load data
russia_cyber <- readRDS(paste0(here::here(), '/data/grayzone_aggregate_new.rds'))
```

## Check data
```{r}
summary(russia_cyber)
```

# Prior data maps
Map the data using prior variable codings from other datasets

## DCID
Map of the DCID cases showing variation in severity
```{r}
dcid <- readRDS(file = paste0(here::here(),"/data/grayzone_dcid.rds"))

country <- unique(dcid$Target)
average_severity <- NULL 
for( i in 1:length(country)){
  average_severity[i] <- round(mean(dcid[dcid$Target == country[i], "Incident severity"]), 2)
}

dcid <- as.data.frame(cbind(country, average_severity), stringsAsFactors = F)
dcid$average_severity <- as.numeric(dcid$average_severity)

map <- rworldmap::joinCountryData2Map(dcid,
                                      nameJoinColumn="country",
                                      joinCode="NAME" )

rworldmap::mapDevice()

mapParams <- rworldmap::mapCountryData(map,
                                       nameColumnToPlot='average_severity',
                                       catMethod = c(2, 2.3, 2.6, 2.9, 3.2, 3.5),
                                       mapTitle = "\nRussian cyber attack severity (2005-2017) - Valeriano and Maness data",
                                       addLegend = FALSE,
                                       xlim = c(-167, 50),
                                       ylim = c(30,50)
                                      )
```

## REI
Map of the REI cases showing variation in severity. Info ops are coded as least severe, cyber disruption as moderate, and material support as most severe. Code each case by whatever is the most severe level that is present.
```{r}
rei <- readRDS(file = paste0(here::here(),"/data/grayzone_rei.rds"))

rei[rei$Target == "Ukraine ", "Target"] <- "Ukraine"

country <- unique(rei$Target)
average_severity <- NULL 
for( i in 1:length(country)){
  average_severity[i] <- round(mean(rei[rei$Target == country[i], "Favorable outcome"]), 2)
}

rei <- as.data.frame(cbind(country, average_severity), stringsAsFactors = F)
rei$average_severity <- as.numeric(rei$average_severity)

map <- rworldmap::joinCountryData2Map(rei,
                                      nameJoinColumn="country",
                                      joinCode="NAME" )

rworldmap::mapDevice()

mapParams <- rworldmap::mapCountryData(map,
                                       nameColumnToPlot = 'average_severity',
                                       catMethod = c(0, 0.4, 0.8, 1.2, 1.6, 2),
                                       mapTitle = "\nRussian cyber attack severity (1994-2017) - Way and Casey data",
                                       #colourPalette = c("lightgoldenrod", "yellow", "orange", "red"),
                                       addLegend = FALSE,
                                       xlim = c(-167, 50),
                                       ylim = c(30,50)
                                      )
```

## Combined
There should only be one case that is coded in both DCID and REI. For all the rest, scale their scores so we get a single score for each case in either dataset and we can compare across datasets. We know this is a rough coding since one is coding severity of the cyber attack and the other is coding the type of attack, but we'll start here.

# Current data maps
```{r}
rei_dcid <- readRDS(paste0(here::here(), "/data/grayzone_aggregate_cpass.rds"))

rei_dcid[rei_dcid$target == "Chechnya", "target"] <- "Russia"

rei_dcid[is.na(rei_dcid[,4]), 4] <- 0
rei_dcid[is.na(rei_dcid[,5]), 5] <- 0
rei_dcid[is.na(rei_dcid[,6]), 6] <- 0
rei_dcid[is.na(rei_dcid[,7]), 7] <- 0
rei_dcid[is.na(rei_dcid[,8]), 8] <- 0

rei_dcid$resp_convmil_gro <- rei_dcid$resp_convmil_gro * 5
rei_dcid$resp_convmil_airsea <- rei_dcid$resp_convmil_airsea * 4
rei_dcid$resp_paramil <- rei_dcid$resp_paramil * 3
rei_dcid$rei_cyberdisrup <- rei_dcid$rei_cyberdisrup * 2

for( i in 1:nrow(rei_dcid)){
  rei_dcid$intensity[i] <- max(rei_dcid$resp_convmil_gro[i], rei_dcid$resp_convmil_airsea[i], rei_dcid$resp_paramil[i], rei_dcid$resp_cyberdisrup[i], rei_dcid$resp_infoops[i])
}

country <- unique(rei_dcid$target)
average_severity <- NULL
for( i in 1:length(country)){
  average_severity[i] <- max(rei_dcid[rei_dcid$target == country[i], "intensity"])
  #average_severity[i] <- round(mean(dcid[dcid$Target == country[i], "severity_comparable"]), 2)
}

rei_dcid <- as.data.frame(cbind(country, average_severity), stringsAsFactors = F)
rei_dcid$average_severity <- as.numeric(rei_dcid$average_severity)
rei_dcid <- rbind(rei_dcid, c("Thailand", 2))

rei_dcid[rei_dcid$average_severity == 1, "average_severity"] <- "1 Info Ops"
rei_dcid[rei_dcid$average_severity == 2, "average_severity"] <- "2 Cyber Disruption"
rei_dcid[rei_dcid$average_severity == 3, "average_severity"] <- "3 Paramilitary"
rei_dcid[rei_dcid$average_severity == 4, "average_severity"] <- "4 Conventional Military (air/sea)"
rei_dcid[rei_dcid$average_severity == 5, "average_severity"] <- "5 Conventional Military (ground)"

map <- rworldmap::joinCountryData2Map(rei_dcid,
                                      nameJoinColumn="country",
                                      joinCode="NAME" )


mapParams <- rworldmap::mapCountryData(map,
                                       nameColumnToPlot='average_severity',
                                       catMethod = "categorical",
                                       #catMethod = c(0, 0.4, 0.8, 1.2, 1.6, 2),
                                       mapTitle = "\n\n\n\nIntensity of Russian activity (1994-2017)",
                                       addLegend = FALSE,
                                       xlim = c(-100,50), #c(-157, 50),
                                       ylim = c(40,70), #c(30,50),
                                       #colourPalette = RColorBrewer::brewer.pal(5, "Greys")
                                       colourPalette = c("grey85", "grey60", "grey40", "grey20", "grey0")
)

mapParams$legendText <- c("Info Ops", "Cyber Disruption", "Paramilitary", "Conventional Military (air/sea)", "Conventional Military (ground)")
```

# New map
Create new dummy df
```{r}
df <- russia_cyber
```

## Get geographic info
Only run once to get lat-lon data for each country to plot them
```{r, eval = FALSE}
library(ggmap)
mykey <- "AIzaSyAfKvl8754pRSsqRJgksUC9fOeq30bjda0"

register_google(key = mykey)

locations <- ggmap::mutate_geocode(df, target, key = mykey)

write.csv(locations, paste0(here::here(), "/data/","locations.csv"))
```

Merge new location info for each country
```{r}
locations <- read.csv(paste0(here::here(), "/data/","locations.csv"))
locations$X <- NULL

df <- dplyr::left_join(df, locations)
```

## Wrangle
We want a single column that is the highest value for each country
```{r}
# Subset columns
df <- df %>%
  dplyr::select(target, dplyr::starts_with("resp"), lon, lat) %>%
  dplyr::select(-resp_convmil) %>%
  dplyr::rename(country = target)

df[is.na(df)] <- 0

# Give ordinal value to each level
df$resp_convmil_gro <- df$resp_convmil_gro * 5
df$resp_convmil_airsea <- df$resp_convmil_airsea * 4
df$resp_paramil <- df$resp_paramil * 3
df$resp_cyberdisrup <- df$resp_cyberdisrup * 2
df$resp_infoops <- df$resp_infoops * 1

# Keep highest value per year
for( i in 1:nrow(df)){
  df$intensity[i] <- max(df$resp_convmil_gro[i],
                         df$resp_convmil_airsea[i],
                         df$resp_paramil[i], 
                         df$resp_cyberdisrup[i], 
                         df$resp_infoops[i])
}

# Subset to the highest value for country
df <- df %>%
  dplyr::group_by(country) %>%
  dplyr::filter(intensity == max(intensity)) %>%
  dplyr::select(country, lon, lat, intensity) %>%
  dplyr::distinct() %>%
  dplyr::mutate(intensity = dplyr::recode_factor(intensity,
                                                 "1" = "Info Ops",
                                                 "2" = "Cyber Disruption",
                                                 "3" = "Paramilitary",
                                                 "4" = "Conventional Military (air/sea)",
                                                 "5" = "Conventional Military (ground)"))
```

## Create new map
We can now make a new map where each country is colored with the highest intensity value
```{r}
map <- df
map$iso <- countrycode::countrycode(map$country, "country.name", "iso3c")

# Drop Chechnya since we don't want to map it and add Kosovo manually
map <- map %>%
  dplyr::filter(!country == "Chechnya")
map$iso[map$country == "Kosovo"] <- "RKS"

map <- rworldmap::joinCountryData2Map(map, 
                                      joinCode = "ISO3", 
                                      nameJoinColumn = "iso", 
                                      verbose = TRUE)

cp <- rworldmap::rwmGetColours(c("light blue", "orange"), 2)

#creating the map
palette <- RColorBrewer::brewer.pal("purples")

map2 <- rworldmap::mapCountryData(map, 
                      xlim = c(-10, 50), 
                      ylim = c(25, 70), 
                      nameColumnToPlot = "intensity", 
                      mapTitle = "Intensity of Russian Interventions (1994-2018)", 
                      catMethod = "categorical",
                      numCats = 5,
                      colourPalette = "heat",
                      oceanCol = "lightblue", 
                      missingCountryCol = "white", 
                      borderCol = "gray33", 
                      addLegend = FALSE, 
                      aspect = 1, 
                      lwd = .3)

do.call(rworldmap::addMapLegend, 
        c(map2, 
          legendLabels = "all",
          legendWidth = 0.5, 
          legendIntervals = "data",
          legendMar = 2))
```
