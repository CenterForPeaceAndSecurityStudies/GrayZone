---
title: "07_FullData"
author: J Andres Gannon, Erik Gartzke, and Jon Lindsay, Center for Peace and Security
  Studies (cPASS)
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '5'
  html_notebook:
    fig_height: 8
    fig_width: 12
    number_sections: yes
    theme: flatly
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: yes
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document compares case and variable coverage across all the Russia cyber data investigated.

The data comes from the following sources:

ICB comes from Brecher, Michael and Jonathan Wilkenfeld (2000). A Study of Crisis. Ann Arbor: University of Michigan Press.

DCID comes from Valeriano, B., & Maness, R. C. (2014). The dynamics of cyber conflict between rival antagonists, 2001–11. Journal of Peace Research, 51(3), 347–360. https://doi.org/10.1177/0022343313518940

REI comes from Casey, Adam; Way, Lucan Ahmad, 2017, "Russian Electoral Interventions, 1991-2017", https://doi.org/10.5683/SP/BYRQQS, Scholars Portal Dataverse

# Preparation
## Load packages
Pipe operators have trouble loading for individual commands
```{r}
library(magrittr)
library(ggplot2)
```

## Load data
Load the cleaned and subset versions of each dataset
```{r}
# Load data
cpass <- readRDS(paste0(here::here(), '/data/grayzone_cpass.rds'))
icb <- readRDS(paste0(here::here(), '/data/grayzone_icb.rds'))
dcid <- readRDS(paste0(here::here(), '/data/grayzone_dcid.rds'))
rei <- readRDS(paste0(here::here(), '/data/grayzone_rei.rds'))
```

# Compare coverage
Before merging the data, compare the different cases covered by each one

## Prep for coverage comparison
```{r}
# Create identifier variables for each dataset
cpass$cpass <- 1
icb$icb <- 1
dcid$dcid <- 1
rei$rei <- 1

# Ensure proper unit of analysis
dplyr::glimpse(cpass)
dplyr::glimpse(icb)
dplyr::glimpse(dcid)
dplyr::glimpse(rei)

# Fix dcid dates to have a year column
dcid <- tidyr::separate(dcid, 'Start date', c("Start Year", "Start Month", "Start Day"), sep = "-")
dcid <- tidyr::separate(dcid, 'End date', c("End Year", "End Month", "End Day"), sep = "-")

# Rename merging variables to make things easier
cpass <- cpass %>% dplyr::rename('Target' = target,
                                 'Year' = year_start)

icb <- icb %>% dplyr::rename('Target' = Target,
                             'Year' = Year)

dcid <- dcid %>% dplyr::rename('Target' = Target,
                               'Year' = 'Start Year')

rei <- rei %>% dplyr::rename('Target' = Target,
                             'Year' = Year)

# Fix date types
cpass$Year <- as.numeric(cpass$Year)
icb$Year <- as.numeric(icb$Year)
dcid$Year <- as.numeric(dcid$Year)
rei$Year <- as.numeric(rei$Year)
```

## Compare case coverage across datasets
```{r}
# Create dataframe versions of just variables to merge for the match
cpass_coverage <- cpass[ , c('Target', 'Year', 'cpass')]
icb_coverage <- icb[ , c('Target', 'Year', 'icb')]
dcid_coverage <- dcid[ , c('Target', 'Year', 'dcid')]
rei_coverage <- rei[ , c('Target', 'Year', 'rei')]

# Merge datasets with just ID vars
coverage <- dplyr::full_join(cpass_coverage, icb_coverage) %>% dplyr::full_join(., dcid_coverage) %>% dplyr::full_join(., rei_coverage)

# Delete duplicates
coverage <- unique(coverage)

# Convert NAs to 0 to make table easier to read
coverage[is.na(coverage)] <- 0

# Sort chronologically
coverage <- coverage[order(coverage$Year, decreasing = FALSE), ]

# Make html table
formattable::formattable(coverage,
                         align = c("c", "c", "c", "c", "c", "c"),
                         list('cpass' = formattable::color_tile("transparent", "lightblue"),
                              'icb' = formattable::color_tile("transparent", "lightblue"),
                              'dcid' = formattable::color_tile("transparent", "lightblue"),
                              'rei' = formattable::color_tile("transparent", "lightblue")))
```

# Merge data

## Duplicates
First we identify the variables of interest in each dataset and those which are duplicates. We exclude the ICB cases here since our universe of cases is restricted to instances of known Russian cyberattacks
```{r}
# Create dataframe versions of just variables to merge for the match
cpass_join <- cpass[ , c('Target', 'Year', 'cpass', 'det_alliance', 'resp_convmil', 'resp_convmil_gro', 'resp_convmil_airsea', 'resp_paramil', 'resp_cyberdisrup', 'resp_infoops', 'outcome_deaths')]

# Rename the dcid severity variable so we know the source
dcid <- dcid %>% dplyr::rename("dcid_severity" = "Incident severity")
dcid_join <- dcid[ , c('Target', 'Year', 'dcid', 'Incident', 'dcid_severity')]

# Rename the rei variables so we know the source
rei <- rei %>% dplyr::rename(
  "rei_infoops" = "Disinformation campaign",
  "rei_cyberdisrup" = "Cyberattack",
  "rei_matsupp" = "Material support")

rei_join <- rei[ , c('Target', 'Year', 'rei', 'rei_infoops', 'rei_cyberdisrup', 'rei_matsupp')]
```

## Merge
```{r}
# Merge datasets with just ID vars
cases_all <- dplyr::full_join(cpass_join, dcid_join) %>% dplyr::full_join(., rei_join)

# Delete duplicates
cases_all <- unique(cases_all)

# Sort chronologically
cases_all <- cases_all[order(cases_all$Year, decreasing = FALSE), ]

```

# Save final dataframe
```{r}
saveRDS(cases_all, paste0(here::here(), "/data/","grayzone_aggregate.rds"))

write.csv(cases_all, paste0(here::here(), "/data/","grayzone_aggregate.csv"))
```
