---
title: "04_FullData"
author: J Andres Gannon, Erik Gartzke, Jon Lindsay, and Peter Schram, Center for Peace and Security
  Studies (cPASS)
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    code_download: true
    toc: yes
  html_notebook:
    toc: yes
    toc_float: yes
editor_options:
  chunk_output_type: inline
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(magrittr)
library(ggplot2)
```

# Load data
Load the newly created data with all relevant covariates
```{r}
df_full <- readRDS(paste0(here::here(), '/data/grayzone_model.rds'))
```

# Create samples
## Data 2: Relevant targets
Only includes states that meet at least one of the following criteria: 1) MID/ICB history with Russia/Soviet Union from 1945-1993, 2) Former Warsaw Pact or Former Soviet Union (FSU) state, 3) contiguity with Russia
```{r}
# Main df
df <- df_full %>%
  dplyr::filter(continent == "Europe")

# Relevant European states
df_conserv <- df %>%
  dplyr::filter(relevant_conserv == 1)

```

## Data 3: Known targets
Only include states that were known targets of an attack from 1994-2018
```{r}

```

# Summary stats
```{r}
DT::datatable(df)
funModeling::plot_num(df)

df %>%
  dplyr::select(intensity, NATOmem_MEM, lnmindistkm_rus) %>%
  dplyr::mutate(intensity = as.numeric(intensity)) %>%
  GGally::ggpairs()
```

## DV: Intensity
```{r}
df_full %>%
  dplyr::filter(!intensity == 0) %>%
  dplyr::select(intensity) %>%
  dplyr::group_by(intensity) %>%
  dplyr::summarise(count = dplyr::n()) %>%
  dplyr::mutate(intensity = dplyr::recode_factor(intensity,
                                                 "1" = "1 Info ops",
                                                 "2" = "2 Cyber Disrup.",
                                                 "3" = "3 Paramil.",
                                                 "4" = "4 Mil (Air/sea)",
                                                 "5" = "5 Mil (Gro)")) %>%
  ggplot(aes(x = intensity,
             y = count)
         ) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count),
            size = 3.5,
            vjust = -0.5) +
  lims(y = c(0, 41)) +
  labs(title = "Intensity of Russia Interventions (1994 - 2018)",
       x = "",
       y = "Number of Country-years"
       ) +
  theme_bw() +
  theme(panel.grid = element_blank(), 
        text = element_text(size = 14)
        )
```

## EV: NATO and distance
```{r}
# NATO


# Minimum distance from Russia

```

## Controls


## Full summary
```{r}
df_full %>%
  dplyr::select(year, intensity, NATOmem_MEM, lnmindistkm_rus, gdppc1_2010const, ln_pop1, civilwar, demo1, nuclear1, cinc_ratio)

```

# Data prep
## Imputing missing values
We create 2 sets of the data, one with known values, and a second with imputed values for missing covariates. The covariates with missing data are noted here and are relevant for inclusion of control variables. In most cases, missing covariates are for later years in the dataset (post-2012 or post-2016). In a few cases, there are countries where certain covariates are not known, like missing GDP data for Kosovo and Luxembourg from the World Bank data.
```{r}
# Identify missingness
naniar::gg_miss_var(df)
visdat::vis_miss(df)
ExPanDaR::prepare_missing_values_graph(df, ts_id = "year")

# Created imputed version
df_imp <- df

# Run MICE with 0 iterations
imp <- mice::mice(df_imp, maxit = 0)

# Extract predictor matrix and methods of imputation
predM <- imp$predictorMatrix
meth <- imp$method

# Set values of variables to leave out as 0
predM[ , c("cabbrev1", "ccode1", 
           "cname2", "cabbrev2", "ccode2", 
           "continent", 
           "relevant_expansive",
           "relevant_conserv",
           "intensity",
           "capdistkm_us", "mindistkm_us", "capdistkm_rus", "mindistkm_rus",
           "lncapdistkm_us", "lnmindistkm_us", "lncapdistkm_rus", "lnmindistkm_rus",
           "NATOmem_MEM", "NATOdur_MEM", 
           "nuclear1", 
           "demo2")] <- 0

# Create 5 imputed datasets
imp2 <- mice::mice(df_imp, 
                   maxit = 5,
                   predictorMatrix = predM,
                   method = meth)

# Convert datasets to long
df_imp_long <- mice::complete(imp2,
                              action = "long",
                              include = TRUE)
```

## Robust standard errors
We use the following function to computer robust standard errors
```{r}
# Robust standard errors
robustse <- function(x, coef = c("logit", "odd.ratio", "probs")) {
    sandwich1 <- function(object, ...) sandwich::sandwich(object) *
                                       nobs(object) / (nobs(object) - 1)
    # Function calculates SE's
    mod1 <- lmtest::coeftest(x, vcov = sandwich1) 
    # apply the function over the variance-covariance matrix
    
    if (coef == "logit") {
    return(mod1) # return logit with robust SE's
    } else if (coef == "odd.ratio") {
    mod1[, 1] <- exp(mod1[, 1]) # return odd ratios with robust SE's
    mod1[, 2] <- mod1[, 1] * mod1[, 2]
    return(mod1)
    } else {
    mod1[, 1] <- (mod1[, 1]/4) # return probabilites with robust SE's
    mod1[, 2] <- mod1[, 2]/4
    return(mod1)
    }
}
```

# Model 1
global baseline "natomem_mem lnmindistkm_rus  i.year"

```{r}
m1a <- MASS::polr(intensity ~ 
                   NATOmem_MEM +
                   lncapdistkm_us +
                   demo1 +
                   civilwar +
                   nuclear1,
                 data = df_euro,
                 method = "probit",
                 Hess = TRUE)

```

# Model 2
global controls1 "natomem_mem lnmindistkm_rus gdppc1_2010const ln_pop1 civilwar demo1 nuclear1 i.year"

```{r}

```

# Model 3
global controls2 "natomem_mem lnmindistkm_rus cinc_ratio_e demo1_e nuclear1 civilwar i.year"

```{r}

```

# Marginal effects

# Alternate specifications
## Extrapolate missingness

## Zero inflated ordered probit

## Alternate samples
### Relevant states

### Known targets



# ***Archive
We create 4 versions of the data below based on the inclusion criteria for the universe of cases. In all cases, the unit of analysis is the country-year
1. Full data - includes all countries in the newly created data on Russian interventions and all European states
2. Expansive subset - includes all European states that meet the 3-prong criteria for potential target or are in the data as targets of an attack post-1994
3. Conservative subset - same as expansive, but does not includes states that were targets post-1993
4. Known attacks - includes only country-years that were targets of a Russian intervention after 1994

## Data 1: European states
This includes all years (1994-2018) of European states
### Models
#### M1a: NATO + US cap distance
```{r}
m1a <- MASS::polr(intensity ~ 
                   NATOmem_MEM +
                   lncapdistkm_us +
                   demo1 +
                   civilwar +
                   nuclear1,
                 data = df_euro,
                 method = "probit",
                 Hess = TRUE)

m1a
summary(m1a)

# Robust standard errors
robustse(m1a, coef = "logit")

# P values
m1a_coef <- data.frame(coef(summary(m1a)))
m1a_coef$pval <- round((pnorm(abs(m1a_coef$t.value), lower.tail = FALSE) * 2), 2)
m1a_coef

# Odds ratios
m1a_or <- exp(coef(m1a))
m1a_or

# Predicted probabilities
m1a_pred <- predict(m1a, type = "probs")
summary(m1a_pred)

# Marginal effects
m1a_me <- erer::ocME(m1a)
m1a_me$out
```


#### M1b: NATO + US min distance
```{r}
m1b <- MASS::polr(intensity ~ 
                   NATOmem_MEM +
                   lnmindistkm_us +
                   demo1 +
                   civilwar +
                   nuclear1,
                 data = df_euro,
                 method = "probit",
                 Hess = TRUE)

m1b
summary(m1b)

# Robust standard errors
robustse(m1b, coef = "logit")

# P values
m1b_coef <- data.frame(coef(summary(m1b)))
m1b_coef$pval <- round((pnorm(abs(m1b_coef$t.value), lower.tail = FALSE) * 2), 2)
m1b_coef

# Odds ratios
m1b_or <- exp(coef(m1b))
m1b_or

# Predicted probabilities
m1b_pred <- predict(m1b, type = "probs")
summary(m1b_pred)

# Marginal effects
m1b_me <- erer::ocME(m1b)
m1b_me$out
```

#### M1c: NATO + Russia cap distance
```{r}
m1c <- MASS::polr(intensity ~ 
                   NATOmem_MEM +
                   lncapdistkm_rus +
                   demo1 +
                   civilwar +
                   nuclear1,
                 data = df_euro,
                 method = "probit",
                 Hess = TRUE)

m1c
summary(m1c)

# Robust standard errors
robustse(m1c, coef = "logit")

# P values
m1c_coef <- data.frame(coef(summary(m1c)))
m1c_coef$pval <- round((pnorm(abs(m1c_coef$t.value), lower.tail = FALSE) * 2), 2)
m1c_coef

# Odds ratios
m1c_or <- exp(coef(m1c))
m1c_or

# Predicted probabilities
m1c_pred <- predict(m1c, type = "probs")
summary(m1c_pred)

# Marginal effects
m1c_me <- erer::ocME(m1c)
m1c_me$out
```

#### M1d: NATO + Russia min distance
```{r}
m1d <- MASS::polr(intensity ~ 
                   NATOmem_MEM +
                   lnmindistkm_rus +
                   demo1 +
                   civilwar +
                   nuclear1,
                 data = df_euro,
                 method = "probit",
                 Hess = TRUE)

m1d
summary(m1d)

# Robust standard errors
robustse(m1d, coef = "logit")

# P values
m1d_coef <- data.frame(coef(summary(m1d)))
m1d_coef$pval <- round((pnorm(abs(m1d_coef$t.value), lower.tail = FALSE) * 2), 2)
m1d_coef

# Odds ratios
m1d_or <- exp(coef(m1d))
m1d_or

# Predicted probabilities
m1d_pred <- predict(m1d, type = "probs")
summary(m1d_pred)

# Marginal effects
m1d_me <- erer::ocME(m1d)
m1d_me$out
```

### Results
```{r}
texreg::texreg(list(m1a, m1b, m1c, m1d),
  digits = 3,
  ci.force = TRUE,
  ci.force.level = 0.95,
  file = "../paper/model1.tex"
)

texreg::screenreg(list(m1a, m1b, m1c, m1d),
  digits = 3,
  ci.force = TRUE,
  ci.force.level = 0.95
)
```

# Cumulative results
## Table
```{r, eval = FALSE}
### Results
```{r}
texreg::texreg(list(m1a, m1b, m1c, m1d),
  custom.model.names = c("Europe", "Europe", "Europe", "Europe",
                         "Relevant", "Relevant", "Relevant", "Relevant",
                         "Expansive", "Expansive", "Expansive", "Expansive",
                         "Known", "Known", "Known", "Known"),  
  digits = 3,
  ci.force = TRUE,
  ci.force.level = 0.95,
  file = "../paper/model1.tex"
)

texreg::screenreg(list(m1a, m1b, m1c, m1d),
  digits = 3,
  ci.force = TRUE,
  ci.force.level = 0.95
)
```

## Figure
```{r, eval = FALSE}
dw1 <- dotwhisker::dwplot(m1a, dot_args = list(size = 2.5),
    whisker_args = list(size = 1.5), 
    color = "black") %>%
    relabel_predictors(c(
       capdistkm_us = "Distance from DC",
       capdistkm_rus = "Distance from Moscow",
       NATOmem_MEM = "NATO membership",
       cinc_ratio = "CINC ratio",
       polity1 = "Polity score",
       civilwar = "Civil war",
       nuclear1 = "Nuclear power",
       gdp1 = "GDP"
        )) +
    geom_vline(xintercept = 0) +
    ggtitle("Coefficient Estimates") +
        theme(plot.title = element_text(face="bold", hjust = -0.0),
        legend.justification=c(0, 0), legend.position=c(0, 0),
        legend.title = element_blank()) +
    scale_colour_discrete(breaks=c(
      "Model 1"
      ),
        labels = c(
        "All Controls")) +
    labs(x = "Intensity of Russian Intervention") + 
    theme_bw() +
    theme(text = element_text(size = 24),
        axis.text.x = element_text(colour="black"), 
        axis.text.y = element_text(colour="black"),
        legend.position = c(0.8, 0.01),
        legend.justification = c(0, 0), 
        legend.background = element_rect(colour="grey80"),
        legend.title = element_blank())
```
