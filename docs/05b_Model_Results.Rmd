---
title: "04_FullData"
author: J Andres Gannon, Erik Gartzke, Jon Lindsay, and Peter Schram, Center for Peace and Security
  Studies (cPASS)
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    code_download: true
    toc: yes
  html_notebook:
    toc: yes
    toc_float: yes
editor_options:
  chunk_output_type: inline
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(magrittr)
library(ggplot2)
```

# Load data
Load the newly created data with all relevant covariates
```{r}
df_full <- readRDS(paste0(here::here(), '/data/grayzone_model.rds'))

# Limit sample to just European states
df <- df_full %>%
  dplyr::filter(continent == "Europe")
```

# Summary stats
```{r}
DT::datatable(df)
funModeling::plot_num(df)

df %>%
  dplyr::select(intensity, NATOmem_MEM, lnmindistkm_rus) %>%
  dplyr::mutate(intensity = as.numeric(intensity)) %>%
  GGally::ggpairs()
```

## DV: Intensity
```{r}
df_full %>%
  dplyr::filter(!intensity == 0) %>%
  dplyr::select(intensity) %>%
  dplyr::group_by(intensity) %>%
  dplyr::summarise(count = dplyr::n()) %>%
  dplyr::mutate(intensity = dplyr::recode_factor(intensity,
                                                 "1" = "1 Info ops",
                                                 "2" = "2 Cyber Disrup.",
                                                 "3" = "3 Paramil.",
                                                 "4" = "4 Mil (Air/sea)",
                                                 "5" = "5 Mil (Gro)")) %>%
  ggplot(aes(x = intensity,
             y = count)
         ) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = count),
            size = 3.5,
            vjust = -0.5) +
  lims(y = c(0, 41)) +
  labs(title = "Intensity of Russia Interventions (1994 - 2018)",
       x = "",
       y = "Number of Country-years"
       ) +
  theme_bw() +
  theme(panel.grid = element_blank(), 
        text = element_text(size = 14)
        )
```

## EV: NATO and distance
```{r}
table(df$intensity, df$NATOmem_MEM)
```

## Controls


## Full summary
```{r}
df_full %>%
  dplyr::select(intensity, NATOmem_MEM, lnmindistkm_rus, gdppc1_2010const, lnpop1, civilwar, demo1, nuclear1, cinc_ratio) %>%
  gtsummary::tbl_summary()

```

# Model 1
From oglmx package: "Inclusion of fixed effects in non-linear models such as probit, logit and their ordered equivalents can lead to biased estimates due to the incidental parameters problem recognised by Neyman and Scott (1948). Further development of the package will add methods to reduce this bias, for example that suggested by Carro (2007) and adapted to the ordered outcome case with two types of fixed effects in Carro and Traferri (2014)."

Carro JM (2007). “Estimating dynamic panel data discrete choice models with fixed effects.” Journal of Econometrics, 140(2), 503–528. ISSN 03044076. doi:10.1016/j.jeconom. 2006.07.023.
Carro JM, Traferri A (2014). “State Dependence and Heterogeneity in Health Using a BiasCorrected Fixed-Effects Estimator.” Journal of Applied Econometrics, 29, 181–207. ISSN 01451707. doi:10.1002/jae.
Neyman J, Scott EL (1948). “Consistent Estimates Based on Partially Consistent Observations.” Econometrica, 16(1), 1–32.

For the baseline model we just look at the relationship between the intensity of Russia intervention and whether the target is a NATO member as well as logged minimum distance from Russia. These are our two independent variables of interest. We use year fixed effects and cluster standard errors at the country level.
```{r}
d <- rms::datadist(df)
options(datadist = "d")


m1 <- rms::lrm(intensity ~
                 NATOmem_MEM +
                 lnmindistkm_rus +
                 year,
               data = df,
               x = TRUE,
               y = TRUE)

## country-clustered standard errors
rms::robcov(m1, df$cabbrev1)

# Show results
ggstatsplot::ggcoefstats(m1)
plot(rms::nomogram(m1, fun = plogis))
```

# Model 2
Independent variables are NATO membership and logged minimum distance from Russia. Controls include GDP per capita, logged population, active civil war, democracy, and nuclear status. We use year fixed effects.
```{r}
d <- rms::datadist(df)
options(datadist = "d")

m2 <- rms::lrm(intensity ~ 
                   NATOmem_MEM +
                   lnmindistkm_rus +
                   gdppc1_2010const +
                   lnpop1 +
                   civilwar +
                   demo1 +
                   nuclear1 +
                   year,
                data = df,
                x = TRUE,
                y = TRUE)

## country-clustered standard errors
rms::robcov(m2, df$cabbrev1)

# Show results
ggstatsplot::ggcoefstats(m2)
plot(rms::nomogram(m2, fun = plogis))
```

# Model 3
For the final model, we include controls for CINC ratio, democracy, nuclear status, and civil war with year fixed effects and country-clustered standard errors.

We have to extrapolate variables for post-2012 since that is the last year that data for CINC scores is available. With the data imputed, now we can run the model
```{r}
# Prep imputaiton model
d <- rms::datadist(df)
options(datadist = "d")

# Run 10 imputations of the variables with missing data using 0 knots for nonlinear terms
m3_imp <- Hmisc::aregImpute(~ cinc1 + 
                              cinc2 +
                              gdp1_2010const +
                              gdppc1_2010const +
                              pop1 +
                              elf +
                              polity1 +
                              NATOmem_MEM +
                              lnmindistkm_rus +
                              cinc_ratio +
                              demo1 +
                              civilwar +
                              nuclear1,
                            nk = 0,
                            tlinear = TRUE, 
                            data = df,
                            n.impute = 10, 
                            pr = FALSE)

# Fit the outcome model following multiple imputation
m3 <- Hmisc::fit.mult.impute(intensity ~ 
                               NATOmem_MEM +
                               lnmindistkm_rus +
                               cinc_ratio +
                               demo1 +
                               civilwar +
                               nuclear1 +
                               year,
                             fitter = rms::lrm, 
                             xtrans = m3_imp,
                             data = df,
                             x = TRUE,
                             y = TRUE)

summary(m3)

## Country-clustered standard errors
rms::robcov(m3, df$cabbrev1)

plot(rms::nomogram(m3, fun = plogis))

```

# Marginal effects

# Alternate specifications
## Zero inflated ordered probit
```{r, eval = FALSE}
#This program estimates the ZIOP loglikelihood function

ZIOP <- function(est,Y,X,Z,data) {					      
	n=nrow(data)							      					  
	llik <- matrix(0, nrow=n, ncol = 1)
	y.cat<-nlevels(as.factor(Y))
	y0<-sort(unique(Y))
	V<-matrix(NA,nrow(data),y.cat)
	for(k in 1:y.cat){
		V[,k]<-Y==y0[k]
		}
	tau<-rep(1,max(Y))
	for (i in 1:max(Y)){
		tau[i]<-ifelse(i==1,est[i],tau[i-1]+exp(est[i]))
		}
	gamma<-est[(y.cat):(y.cat+ncol(Z)-1)]
	beta<-est[(y.cat+ncol(Z)):length(est)]
	ZG<-Z%*%gamma
	XB<-X%*%beta
	
	cprobs<-matrix(nrow=length(XB),ncol=y.cat)
	probs<-matrix(nrow=n,ncol=y.cat)
	     
	for(j in 1:(y.cat-1)){
		
		cprobs[,j]<-pnorm(tau[j]-XB)
		
		}
	
	probs[,y.cat]<-(1-cprobs[,(y.cat-1)])*pnorm(ZG) 
	probs[,1]<-(cprobs[,1])*pnorm(ZG)+(1-pnorm(ZG))	
	
	for(j in 2:(y.cat-1)){			
		
		probs[,j]<-(cprobs[,j]-cprobs[,(j-1)])*(pnorm(ZG))
		
		}
	
	llik<--1*sum( log(probs[V]) )
	
	return(llik)
	
	}



#set starting parameters
est<-rbind(.1,.1,.1,.1,.1,.1,.1,.1)

#set data, Y, X, and Z
data<-dataset
Y<-dataset$y
X<-cbind(dataset$x1,dataset$x2)
Z<-cbind(1, dataset$x1, dataset$x2)

#optimize
output.ZIOP<-nlm(f=ZIOP,  p=est, Y=Y,X=X,Z=Z ,iterlim=500, data=dataset, hessian=TRUE)
print(output.ZIOP)
vcv<-solve(output.ZIOP$hessian)
vcv 

```

## Alternate samples
1. Full data - includes all countries in the newly created data on Russian interventions and all European states
2. Expansive subset - includes all European states that meet the 3-prong criteria for potential target or are in the data as targets of an attack post-1994
3. Conservative subset - same as expansive, but does not includes states that were targets post-1993
4. Known attacks - includes only country-years that were targets of a Russian intervention after 1994

### Relevant states
Only includes states that meet at least one of the following criteria: 1) MID/ICB history with Russia/Soviet Union from 1945-1993, 2) Former Warsaw Pact or Former Soviet Union (FSU) state, 3) contiguity with Russia
```{r}
# Relevant European states
df_conserv <- df %>%
  dplyr::filter(relevant_conserv == 1)
```

### Known targets

# ***Archive
We create 4 versions of the data below based on the inclusion criteria for the universe of cases. In all cases, the unit of analysis is the 
This includes all years (1994-2018) of European states
```{r, eval = FALSE}
# P values
m1a_coef <- data.frame(coef(summary(m1a)))
m1a_coef$pval <- round((pnorm(abs(m1a_coef$t.value), lower.tail = FALSE) * 2), 2)
m1a_coef

# Odds ratios
m1a_or <- exp(coef(m1a))
m1a_or

# Predicted probabilities
m1a_pred <- predict(m1a, type = "probs")
summary(m1a_pred)

# Marginal effects
m1a_me <- erer::ocME(m1a)
m1a_me$out
```

Table of regression results
```{r, eval = FALSE}
texreg::texreg(list(m1a, m1b, m1c, m1d),
  digits = 3,
  ci.force = TRUE,
  ci.force.level = 0.95,
  file = "../paper/model1.tex"
)

texreg::screenreg(list(m1a, m1b, m1c, m1d),
  digits = 3,
  ci.force = TRUE,
  ci.force.level = 0.95
)
```

Cumulative results table
```{r, eval = FALSE}
### Results
texreg::texreg(list(m1a, m1b, m1c, m1d),
  custom.model.names = c("Europe", "Europe", "Europe", "Europe",
                         "Relevant", "Relevant", "Relevant", "Relevant",
                         "Expansive", "Expansive", "Expansive", "Expansive",
                         "Known", "Known", "Known", "Known"),  
  digits = 3,
  ci.force = TRUE,
  ci.force.level = 0.95,
  file = "../paper/model1.tex"
)

texreg::screenreg(list(m1a, m1b, m1c, m1d),
  digits = 3,
  ci.force = TRUE,
  ci.force.level = 0.95
)
```

Cumulative results figure
```{r, eval = FALSE}
dw1 <- dotwhisker::dwplot(m1a, dot_args = list(size = 2.5),
    whisker_args = list(size = 1.5), 
    color = "black") %>%
    relabel_predictors(c(
       capdistkm_us = "Distance from DC",
       capdistkm_rus = "Distance from Moscow",
       NATOmem_MEM = "NATO membership",
       cinc_ratio = "CINC ratio",
       polity1 = "Polity score",
       civilwar = "Civil war",
       nuclear1 = "Nuclear power",
       gdp1 = "GDP"
        )) +
    geom_vline(xintercept = 0) +
    ggtitle("Coefficient Estimates") +
        theme(plot.title = element_text(face="bold", hjust = -0.0),
        legend.justification=c(0, 0), legend.position=c(0, 0),
        legend.title = element_blank()) +
    scale_colour_discrete(breaks=c(
      "Model 1"
      ),
        labels = c(
        "All Controls")) +
    labs(x = "Intensity of Russian Intervention") + 
    theme_bw() +
    theme(text = element_text(size = 24),
        axis.text.x = element_text(colour="black"), 
        axis.text.y = element_text(colour="black"),
        legend.position = c(0.8, 0.01),
        legend.justification = c(0, 0), 
        legend.background = element_rect(colour="grey80"),
        legend.title = element_blank())
```

MICE imputation
```{r, eval = FALSE}
# Run MICE with 0 iterations
imp <- mice::mice(df, maxit = 0)

# Extract predictor matrix and methods of imputation
predM <- imp$predictorMatrix
meth <- imp$method

# Set values of variables to leave out as 0
predM[ , c("cabbrev1", "ccode1", 
           "cname2", "cabbrev2", "ccode2", 
           "continent", 
           "relevant_expansive",
           "relevant_conserv",
           "intensity",
           "capdistkm_us", "mindistkm_us", "capdistkm_rus", "mindistkm_rus",
           "lncapdistkm_us", "lnmindistkm_us", "lncapdistkm_rus", "lnmindistkm_rus",
           "NATOmem_MEM", "NATOdur_MEM", 
           "nuclear1", 
           "demo2",
           "age1")] <- 0

# Create 5 imputed datasets
imp2 <- mice::mice(df, 
                   maxit = 5,
                   predictorMatrix = predM,
                   method = 'cart',
                   seed = 500)

# See distribution of imputed values relative to baseline data
mice::densityplot(imp2)

# Run regression on the 5 imputed datasets
fit <- with(imp2, rms::lrm(intensity ~ 
                             NATOmem_MEM +
                             lnmindistkm_rus +
                             cinc_ratio +
                             demo1 +
                             civilwar +
                             nuclear1 +
                             year,
                           x = TRUE,
                           y = TRUE))

# summary(mice::pool(fit))


# Convert datasets to long
df_imp_long <- mice::complete(imp2,
                              action = "all",
                              include = FALSE)
```
