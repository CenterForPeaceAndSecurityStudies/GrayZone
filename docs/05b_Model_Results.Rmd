---
title: "04_FullData"
author: J Andres Gannon, Erik Gartzke, Jon Lindsay, and Peter Schram, Center for Peace and Security
  Studies (cPASS)
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    code_download: true
    toc: yes
  html_notebook:
    toc: yes
    toc_float: yes
editor_options:
  chunk_output_type: inline
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
library(magrittr)
library(ggplot2)
```

# Load data
Load the newly created data with all relevant covariates
```{r}
df <- readRDS(paste0(here::here(), '/data/grayzone_model.rds'))
```

# Data summary
Basic summary statistics of the data and what it includes
```{r}
DT::datatable(df)
funModeling::plot_num(df)

df %>%
  dplyr::select(intensity, capdistkm_us, capdistkm_rus, NATOmem_MEM) %>%
  GGally::ggpairs()
```

# Imputing missing values
We create 2 sets of the data, one with known values, and a second with imputed values for missing covariates. The covariates with missing data are noted here and are relevant for inclusion of control variables. In most cases, missing covariates are for later years in the dataset (post-2012 or post-2016). In a few cases, there are countries where certain covariates are not known, like missing GDP data for Kosovo and Luxembourg from the World Bank data.
```{r}
# Identify missingness
naniar::gg_miss_var(df)
visdat::vis_miss(df)
ExPanDaR::prepare_missing_values_graph(df, ts_id = "year")

# Created imputed version
aout <- df %>%
  dplyr::select(-c(cabbrev1, ccode1, cname2, cabbrev2, ccode2)) %>%
  Amelia::amelia(m = 10,
                 ts = "year",
                 cs = "cname1",
                 idvars = "intensity",
                 polytime = 1,
                 interecs = TRUE,
                 p2s = 1)

# Plot imputation values for the variables with missing data
plot(aout)

Amelia::overimpute(aout, var = "cinc1")
Amelia::overimpute(aout, var = "cinc2")
Amelia::overimpute(aout, var = "cinc_ratio")
Amelia::overimpute(aout, var = "polity1")
Amelia::overimpute(aout, var = "polity2")
Amelia::overimpute(aout, var = "polity_intaxn")
Amelia::overimpute(aout, var = "gdp2_2010const")
```

# Data subsetting
We create 4 versions of the data below based on the inclusion criteria for the universe of cases. In all cases, the unit of analysis is the country-year
1. Full data - includes all countries in the newly created data on Russian interventions and all European states
2. Expansive subset - includes all European states that meet the 3-prong criteria for potential target or are in the data as targets of an attack post-1994
3. Conservative subset - same as expansive, but does not includes states that were targets post-1993
4. Known attacks - includes only country-years that were targets of a Russian intervention after 1994

## Data 1: Full data
This includes all country-years of all states either in Europe or targets of an attack

### Subset and impute
```{r}
# No imputed values
df_full <- df

# Imputed values
aout
```

### Models
```{r}
m1 <- MASS::polr(intensity ~ 
                   NATOmem_MEM +
                   capdistkm_us +
                   nuclear1,
                 data = df_full,
                 method = "probit",
                 Hess = TRUE)

# Try 1
lmtest::coeftest(m1, vcov = sandwich::vcovCL(m1, df_full$ccode1))

# Try 2
robustse <- function(x, coef = c("logit", "odd.ratio", "probs")) {
    sandwich1 <- function(object, ...) sandwich::sandwich(object) *
                                       nobs(object) / (nobs(object) - 1)
    # Function calculates SE's
    mod1 <- lmtest::coeftest(x, vcov = sandwich1) 
    # apply the function over the variance-covariance matrix
    
    if (coef == "logit") {
    return(mod1) # return logit with robust SE's
    } else if (coef == "odd.ratio") {
    mod1[, 1] <- exp(mod1[, 1]) # return odd ratios with robust SE's
    mod1[, 2] <- mod1[, 1] * mod1[, 2]
    return(mod1)
    } else {
    mod1[, 1] <- (mod1[, 1]/4) # return probabilites with robust SE's
    mod1[, 2] <- mod1[, 2]/4
    return(mod1)
    }
}

robustse(m1, coef = "logit")

m2 <- ordinal::clm(intensity ~ 
                     NATOmem_MEM +
                     mindistkm_us +
                     nuclear1,
                   data = df_full,
                 link = "probit")

m3 <- ordinal::clm(intensity ~ 
                     NATOmem_MEM +
                     capdistkm_rus +
                     nuclear1,
                   data = df_full,
                 link = "probit")

m4 <- ordinal::clm(intensity ~ 
                     NATOmem_MEM +
                     mindistkm_us +
                     nuclear1,
                   data = df_full,
                 link = "probit")

summary(m1)
summary(m2)
summary(m3)
summary(m4)
```

## Data 2: Expansive subset
Excludes non-European countries from the data (US, Canada, Saudi Arabia, and Syria)

### Subset and impute
```{r}
# No imputed values
df_expansive <- df %>%
  dplyr::filter(relevant_expansive == 1)

# Imputed values

```

### Models
```{r}
m1 <- oglmx::oglmx(intensity ~ 
                     NATOmem_MEM +
                     capdistkm_us +
                     nuclear1,
                   data = df_expansive,
                   link = "probit")

m2 <- oglmx::oglmx(intensity ~ 
                     NATOmem_MEM +
                     mindistkm_us +
                     nuclear1,
                   data = df_expansive,
                   link = "probit")

m3 <- oglmx::oglmx(intensity ~ 
                     NATOmem_MEM +
                     capdistkm_rus +
                     nuclear1,
                   data = df_expansive,
                   link = "probit")

m4 <- oglmx::oglmx(intensity ~ 
                     NATOmem_MEM +
                     mindistkm_us +
                     nuclear1,
                   data = df_expansive,
                   link = "probit")

summary(m1)
summary(m2)
summary(m3)
summary(m4)
```

## Data 3: Conservative subset
Excludes politically irrelevant European countries from the subset, meaning it only includes states that meet at least one of the following criteria: 1) MID/ICB history with Russia/Soviet Union from 1945-1993, 2) Former Warsaw Pact or Former Soviet Union (FSU) state, 3) contiguity with Russia

### Subset and impute
```{r}
# No imputed values
df_conserv <- df %>%
  dplyr::filter(relevant_conserv == 1)

# Imputed values

```

### Models
```{r}
m1 <- oglmx::oglmx(intensity ~ 
                     NATOmem_MEM +
                     capdistkm_us +
                     nuclear1,
                   data = df_conserv,
                   link = "probit")

m2 <- oglmx::oglmx(intensity ~ 
                     NATOmem_MEM +
                     mindistkm_us +
                     nuclear1,
                   data = df_conserv,
                   link = "probit")

m3 <- oglmx::oglmx(intensity ~ 
                     NATOmem_MEM +
                     capdistkm_rus +
                     nuclear1,
                   data = df_conserv,
                   link = "probit")

m4 <- oglmx::oglmx(intensity ~ 
                     NATOmem_MEM +
                     mindistkm_us +
                     nuclear1,
                   data = df_conserv,
                   link = "probit")

summary(m1)
summary(m2)
summary(m3)
summary(m4)
```

## Data 4: Known attacks
This includes only country-years where there was a known Russian attack. As a result, there are no values of 0 for the DV. This sample includes non-European states like the US, Canada, Saudi Arabia, and Syria

### Subset and impute
```{r}
# No imputed values
df_known <- df %>%
  dplyr::filter(!intensity == 0)

# Imputed values

```

### Models
We try the 4 different distance metrics
```{r}
m1 <- oglmx::oglmx(intensity ~ 
                     NATOmem_MEM +
                     capdistkm_us +
                     nuclear1,
                   data = df_known,
                   link = "probit")

m2 <- oglmx::oglmx(intensity ~ 
                     NATOmem_MEM +
                     mindistkm_us +
                     nuclear1,
                   data = df_known,
                   link = "probit")

m3 <- oglmx::oglmx(intensity ~ 
                     NATOmem_MEM +
                     capdistkm_rus +
                     nuclear1,
                   data = df_known,
                   link = "probit")

m4 <- oglmx::oglmx(intensity ~ 
                     NATOmem_MEM +
                     mindistkm_us +
                     nuclear1,
                   data = df_known,
                   link = "probit")

summary(m1)
summary(m2)
summary(m3)
summary(m4)
```

# Cumulative results
## Table
```{r, eval = FALSE}
texreg::texreg(
  list(m1),
  custom.model.names = c(
    "All Controls"
  ),
  custom.coef.names = c(
    "Intercept", "Distance from DC", "Distance from Moscow", "NATO membership", "CINC ratio", "Polity Score", "Civil War", "Nuclear power", "GDP"),
  digits = 3,
  ci.force = TRUE,
  ci.force.level = 0.95,
  file = "../paper/model.tex"
)
```

## Figure
```{r, eval = FALSE}
dw1 <- dotwhisker::dwplot(m1, dot_args = list(size = 2.5),
    whisker_args = list(size = 1.5), 
    color = "black") %>%
    relabel_predictors(c(
       capdistkm_us = "Distance from DC",
       capdistkm_rus = "Distance from Moscow",
       NATOmem_MEM = "NATO membership",
       cinc_ratio = "CINC ratio",
       polity1 = "Polity score",
       civilwar = "Civil war",
       nuclear1 = "Nuclear power",
       gdp1 = "GDP"
        )) +
    geom_vline(xintercept = 0) +
    ggtitle("Coefficient Estimates") +
        theme(plot.title = element_text(face="bold", hjust = -0.0),
        legend.justification=c(0, 0), legend.position=c(0, 0),
        legend.title = element_blank()) +
    scale_colour_discrete(breaks=c(
      "Model 1"
      ),
        labels = c(
        "All Controls")) +
    labs(x = "Intensity of Russian Intervention") + 
    theme_bw() +
    theme(text = element_text(size = 24),
        axis.text.x = element_text(colour="black"), 
        axis.text.y = element_text(colour="black"),
        legend.position = c(0.8, 0.01),
        legend.justification = c(0, 0), 
        legend.background = element_rect(colour="grey80"),
        legend.title = element_blank())
```
