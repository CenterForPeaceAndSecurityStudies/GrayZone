---
title: "04_FullData"
author: J Andres Gannon, Erik Gartzke, Jon Lindsay, and Peter Schram, Center for Peace and Security
  Studies (cPASS)
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    code_download: true
    code_folding: hide
    toc: yes
    number_sections: yes
    toc_float:
      collapsed: yes
  html_notebook:
    toc: yes
    toc_float: yes
editor_options:
  chunk_output_type: inline
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, error = FALSE)
library(magrittr)
library(ggplot2)
```

# Load data
Load the newly created data with all relevant covariates
```{r}
df_full <- readRDS(paste0(here::here(), '/data/grayzone_model.rds'))

# Limit sample to just European states
df <- df_full %>%
  dplyr::filter(continent == "Europe")
```

# European sample
## Model 1
For the baseline model we just look at the relationship between the intensity of Russia intervention and whether the target is a NATO member as well as logged minimum distance from Russia. These are our two independent variables of interest. We use year fixed effects and cluster standard errors at the country level.
```{r}
# Prep matrix inversion option for model
d <- rms::datadist(df)
options(datadist = "d")

# Model
m1 <- rms::lrm(intensity ~
                 NATOmem_MEM +
                 lnmindistkm_rus +
                 year,
               data = df,
               x = TRUE,
               y = TRUE)

## country-clustered standard errors
m1 <- rms::robcov(m1, df$cabbrev1)

# Show results
texreg::screenreg(m1)

ggstatsplot::ggcoefstats(m1,
                         title = "Model 1",
                         package = "ggsci",
                         only.significant = TRUE,
                         palette = "category20c_d3",
                         )

ggeffects::ggpredict(m1) %>%
  plot()
```

## Model 2
Independent variables are NATO membership and logged minimum distance from Russia. Controls include GDP per capita, logged population, democracy, and nuclear status. We use year fixed effects.
```{r}
d <- rms::datadist(df)
options(datadist = "d")

m2 <- rms::lrm(intensity ~ 
                 NATOmem_MEM +
                 lnmindistkm_rus +
                 demo1 +
                 nuclear1 +
                 lnpop1 +
                 gdppc1_2010const +
                 year,
                data = df,
                x = TRUE,
                y = TRUE)

## country-clustered standard errors
m2 <- rms::robcov(m2, df$cabbrev1)

# Show results
texreg::screenreg(m2)

ggstatsplot::ggcoefstats(m2,
                         title = "Model 2",
                         package = "ggsci",
                         only.significant = TRUE,
                         palette = "category20c_d3",
                         )

ggeffects::ggpredict(m2) %>%
  plot()
```

## Model 3
For the final model, we include controls for CINC ratio, democracy, nuclear status, and civil war with year fixed effects and country-clustered standard errors.
```{r}
# Exclude post-2012 observations since missing control variables (cinc) cause a singular information matrix for the year variable
df_m3 <- df

df_m3$year <- as.integer(df_m3$year) + 1993

df_m3 <- df_m3 %>%
  dplyr::filter(year < 2013) %>%
  dplyr::mutate(year = as.factor(year))

# Model
m3 <- rms::lrm(intensity ~ 
                 NATOmem_MEM +
                 lnmindistkm_rus +
                 demo1 +
                 nuclear1 +
                 cinc_ratio +
                 year,
               data = df_m3,
               x = TRUE,
               y = TRUE)

## country-clustered standard errors
m3 <- rms::robcov(m3, df_m3$cabbrev1)

# Show results
texreg::screenreg(m3)

ggstatsplot::ggcoefstats(m3,
                         title = "Model 3",
                         package = "ggsci",
                         only.significant = TRUE,
                         palette = "category20c_d3",
                         )

ggeffects::ggpredict(m3) %>%
  plot()
```

# Relevant states sample
We run the same models as above on a different sample. Here, we limit sample to European states that meet any 3 of the following criteria:

1. **History of conflict** -- European states that have had a MID or ICB incident with Russia/the Soviet Union from 1945-1994.

2. **Former Soviet Union/Warsaw Pact** -- European states that were formerly members of either the Soviet Union or Warsaw Pact.

3. **Contiguity** -- European states that are contiguous with Russia.

```{r}
df_conserv <- df %>%
  dplyr::filter(relevant_conserv == 1)
```

## Model 4
Replicate model 1 with the new sample
```{r}
# Prep matrix inversion option for model
d <- rms::datadist(df_conserv)
options(datadist = "d")

# Model
m4 <- rms::lrm(intensity ~
                 NATOmem_MEM +
                 lnmindistkm_rus +
                 year,
               data = df_conserv,
               x = TRUE,
               y = TRUE)

## country-clustered standard errors
m4 <- rms::robcov(m4, df_conserv$cabbrev1)

# Show results
texreg::screenreg(m4)

ggstatsplot::ggcoefstats(m4,
                         title = "Model 4",
                         package = "ggsci",
                         only.significant = TRUE,
                         palette = "category20c_d3",
                         )

ggeffects::ggpredict(m4) %>%
  plot()
```

## Model 5
Replicate model 2
```{r}
d <- rms::datadist(df_conserv)
options(datadist = "d")

# Model
m5 <- rms::lrm(intensity ~ 
                 NATOmem_MEM +
                 lnmindistkm_rus +
                 demo1 +
                 nuclear1 +
                 lnpop1 +
                 gdppc1_2010const +
                 year,
               data = df_conserv,
               x = TRUE,
               y = TRUE)

## country-clustered standard errors
m5 <- rms::robcov(m5, df_conserv$cabbrev1)

# Show results
texreg::screenreg(m5)

ggstatsplot::ggcoefstats(m5,
                         title = "Model 2",
                         package = "ggsci",
                         only.significant = TRUE,
                         palette = "category20c_d3",
                         )

ggeffects::ggpredict(m5) %>%
  plot()
```

## Model 6
Replicate model 3 on the new sample
```{r}
# Exclude post-2012 observations since missing control variables (cinc) cause a singular information matrix for the year variable
df_m6 <- df_conserv

df_m6$year <- as.integer(df_m6$year) + 1993

df_m6 <- df_m6 %>%
  dplyr::filter(year < 2013) %>%
  dplyr::mutate(year = as.factor(year))

# Model
m6 <- rms::lrm(intensity ~ 
                 NATOmem_MEM +
                 lnmindistkm_rus +
                 demo1 +
                 nuclear1 +
                 cinc_ratio +
                 year,
               data = df_m6,
               x = TRUE,
               y = TRUE)

## country-clustered standard errors
m6 <- rms::robcov(m6, df_m6$cabbrev1)

# Show results
texreg::screenreg(m6)

ggstatsplot::ggcoefstats(m6,
                         title = "Model 6",
                         package = "ggsci",
                         only.significant = TRUE,
                         palette = "category20c_d3",
                         )

ggeffects::ggpredict(m6) %>%
  plot()
```

# Compiled results
```{r}
# Make list of models
models <- list(m1, m2, m3, m4, m5, m6)

# HTML version for markdown
texreg::screenreg(models,
                stars = c(0.01, 0.05, 0.1, 0.15),
                symbol = "\\dagger",
                omit.coef = "(y)",
              custom.coef.names = c("NATO member",
                                     "Russia min. distance",
                                     "Democracy",
                                     "Non-nuclear power",
                                     "Population",
                                     "GDP per capita",
                                     "CINC ratio"),
                custom.gof.rows = list("Fixed effects" = c("Yes", "Yes", "Yes", "Yes", "Yes", "Yes"), 
                                       "Controls" = c("No", "Yes", "Yes", "No", "Yes", "Yes")),
                custom.header = list("Full sample" = 1:3, "Relevant states sample" = 4:6))

# Tex version for manuscript
texreg::texreg(models,
                stars = c(0.01, 0.05, 0.1, 0.15),
                symbol = "\\dagger",
                omit.coef = "(y)",
              custom.coef.names = c("NATO member",
                                     "Russia min. distance",
                                     "Democracy",
                                     "Non-nuclear power",
                                     "Population",
                                     "GDP per capita",
                                     "CINC ratio"),
                custom.gof.rows = list("Fixed effects" = c("Yes", "Yes", "Yes", "Yes", "Yes", "Yes")),
                custom.header = list("Full sample" = 1:3, "Relevant states sample" = 4:6),
               label = "table:model",
               caption = "All models are ordinal probits with year fixed effects and standard errors clustered at the country level. Coefficients have been standardized for easier comparison",
               float.pos = "h",
               file = paste0(here::here(), "/paper/figures/","model.tex")
               )
```

# Marginal effects
