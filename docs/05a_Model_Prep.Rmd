---
title: "05 Model Preparation"
author: J Andres Gannon, Erik Gartzke, Jon Lindsay, and Peter Schram Center for Peace and Security
  Studies (cPASS)
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    code_download: true
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: '5'
    toc_float:
      collapsed: yes
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
library(magrittr)
library(ggplot2)
options(scipen = 999)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = TRUE)
```

# Load
Load the newly created data of Russia interventions post-1994.
```{r}
df <- readRDS(paste0(here::here(), '/data/grayzone_aggregate_new.rds'))
```

# Clean
Drop columns that describe the coding process. This table shows a list of the 60 unique target-years in the data. It drops 22 cases that are repeat Russian interventions with the same target-year.
```{r}
# Subset
df <- df %>% dplyr::select(dplyr::starts_with("resp_"), target, year_start) %>%
    dplyr::rename(year = year_start) %>%
    dplyr::mutate(target = dplyr::recode(target, US = "United States", UK = "United Kingdom"))
df$target <- stringr::str_trim(df$target)

# Figure out how to deal with multiple observations within a country-year
df %>% dplyr::select(target, year) %>%
  dplyr::distinct() %>%
  DT::datatable()
```

# Add variables
We add a battery of variables for the RHS of the model. First, prep by adding target state COW country codes. SideB is always Russia, so we can hard-code that variable.
```{r}
# COW codes
df$ccode1 <- countrycode::countrycode(df$target, "country.name", "cown")
df$ccode2 <- 365
```

## Distance from US
This is the independent variable of interest, coding how far the target state is from the US as the geographic proxy for deterrence. We code minimum distance using the Gleditsch and Ward cshapes dataset.
```{r}
df_dist <- read.table(paste0(here::here(), '/inst/extdata/distance.txt'), header = TRUE)

df_dist <- df_dist %>% dplyr::filter(ccode1 > ccode2) %>%
  dplyr::filter(ccode2 == 2) %>%
  dplyr::select(ccode1, mindist, year) %>%
  dplyr::rename(mindist_us = mindist)

df <- dplyr::left_join(df, df_dist)

# Code distance between the US and the US as 0
df$mindist_us[df$ccode1 == 2] <- 0

df$mindist_us <- round(df$mindist_us, digits = 0)
```

## Distance from Russia
We code distance from Russia to control for Russian resolve using the same data as above.
```{r}
df_dist <- read.table(paste0(here::here(), '/inst/extdata/distance.txt'), header = TRUE)

df <- dplyr::left_join(df, df_dist)
df <- df %>% dplyr::rename(mindist_rus = mindist)
df$mindist_rus <- round(df$mindist_rus, digits = 0)

# Code the distance between Russia and Chechnya as 0
df$mindist_rus[df$target == "Chechnya"] <- 0
```

## CINC scores
We code CINC scores to control for power disparity between the two actors. Constitent with conventional measures, we also cide the ratio of the challenger's (Russia) material capabilities ot the sum of both states capabilities
```{r}
cinc <- read.csv(paste0(here::here(), '/inst/extdata/NMC_5_0.csv'))

cinc_ccode1 <- cinc %>% dplyr::select(ccode, year, cinc) %>%
  dplyr::rename(ccode1 = ccode, cinc1 = cinc)
df <- dplyr::left_join(df, cinc_ccode1)

cinc_ccode2 <- cinc %>% dplyr::select(ccode, year, cinc) %>%
  dplyr::rename(ccode2 = ccode, cinc2 = cinc)
df <- dplyr::left_join(df, cinc_ccode2)

df$cinc_ratio <- df$cinc2/(df$cinc1+df$cinc2)
```

## Regime type
We code polity scores to control for whether or not both sides are democracies. In alignment with Gartzke and Jo 2009, they are re-scales from -10-10 to 0-20 so allow for a multiplicative variable
```{r}
polity <- psData::PolityGet(vars = 'polity2', OutCountryID = 'cown')
polity$polity2_scaled <- polity$polity2 + 10

polity_ccode1 <- polity %>% dplyr::select(cown, year, polity2_scaled) %>%
  dplyr::rename(ccode1 = cown, polity1 = polity2_scaled)
df <- dplyr::left_join(df, polity_ccode1)

polity_ccode2 <- polity %>% dplyr::select(cown, year, polity2_scaled) %>%
  dplyr::rename(ccode2 = cown, polity2 = polity2_scaled)
df <- dplyr::left_join(df, polity_ccode2)

df$polity_intaxn <- df$polity1 * df$polity2
```

## Civil war
We use UCDP to code whether a country-year is involved in an intrastate war
```{r}
load(paste0(here::here(), "/inst/extdata/ucdp-prio-acd-201.RData"))
ucdp <- ucdp_prio_acd_201
ucdp <- ucdp %>% dplyr::select(gwno_a, year, type_of_conflict) %>%
  dplyr::rename(ccode1 = gwno_a) %>%
  dplyr::mutate(ccode1 = strsplit(as.character(ccode1), ",")) %>%
  tidyr::unnest(ccode1) %>%
  dplyr::filter(type_of_conflict == 3) %>%
  dplyr::mutate(civilwar = 1) %>%
  dplyr::select(-type_of_conflict)

ucdp$ccode1 <- as.numeric(stringr::str_trim(ucdp$ccode1))
ucdp <- ucdp %>% dplyr::distinct()
df <- dplyr::left_join(df, ucdp)
df$civilwar[is.na(df$civilwar)] <- 0
```

## Nuclear status
We code nuclear status of the target state using the coding from from Jo and Gartzke 2007
```{r}
df$nuclear1 <- 0
df$nuclear1[df$target == "France" | 
            df$target == "United Kingdom" |
            df$target == "United States"] <- 1
```

## GDP
We code GDP of Russia and the target state using the World Bank's World Development Indicator (WDI) published in Graham and Tucker 2017.
```{r}
ipe <- rio::import(paste0(here::here(), "/inst/extdata/ipe_data_resource/3. Graham_Tucker_IPE_v2_0.RDATA"))

ipe_ccode1 <- ipe %>% dplyr::select(year, ccode, gdp_WDI_PW) %>%
  dplyr::rename(ccode1 = ccode, gdp1 = gdp_WDI_PW)
df <- dplyr::left_join(df, ipe_ccode1)

ipe_ccode2 <- ipe %>% dplyr::select(year, ccode, gdp_WDI_PW) %>%
  dplyr::rename(ccode2 = ccode, gdp2 = gdp_WDI_PW)
df <- dplyr::left_join(df, ipe_ccode2)
```

# Data Summary
That leaves us with a dataset where the unit of analysis is the country-year, the universe of cases is country-years that were the targets of Russian intervention from 1994-2017, and the dependent variable is the means of Russian intervention, coded as dummy variables for the 5 different forms of intervention.
```{r}
DT::datatable(df)
naniar::gg_miss_var(df)
ExPanDaR::prepare_missing_values_graph(df, ts_id = "year")
funModeling::plot_num(df)
```

# Save data
Save the final version of the data that is now prepped for modeling
```{r}
saveRDS(df, paste0(here::here(), "/data/","grayzone_model.rds"))
write.csv(df, paste0(here::here(), "/data/","grayzone_model.csv"))
```

# System info
This markdown file was last run and replicated on the following system
```{r}
Sys.info()
```
