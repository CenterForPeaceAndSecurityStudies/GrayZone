---
title: "05 Model Preparation"
author: J Andres Gannon, Erik Gartzke, Jon Lindsay, and Peter Schram Center for Peace and Security
  Studies (cPASS)
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    code_download: true
    df_print: paged
    number_sections: yes
    toc: yes
    toc_depth: '5'
    toc_float:
      collapsed: yes
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
library(magrittr)
library(ggplot2)
options(scipen = 999)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = TRUE)
```

# Load
Load the newly created data of Russia interventions post-1994.
```{r}
df <- readRDS(paste0(here::here(), '/data/grayzone_aggregate_new.rds'))
```

Load a blank dataset of European countries from 1994-2018
```{r}
countries <- read.csv(paste0(here::here(), "/data/countries_list.csv"))

# Convert to vector
countries <- as.character(sort(unique(countries$country)))

full <- data.frame(expand.grid(country = c(countries),
                 year = 1994:2018))
full$country <- as.character(full$country)

# country code and subset to only countries with COW codes
full$country_code_cow <- countrycode::countrycode(full$country, "country.name", "cown")
full <- full[!is.na(full$country_code_cow), ]
full$country_code_cow <- as.character(full$country_code_cow)

# country COW abbreviation
full$country_abbrev_cow <- countrycode::countrycode(full$country_code, "cown", "cowc")

# continent
full$continent <- countrycode::countrycode(full$country_code_cow, 'cown', 'continent')

# Subset to Europe
full <- full %>%
  dplyr::filter(continent == "Europe")
```

# Clean
Drop columns that describe the coding process. This table shows a list of the 60 unique target-years in the data. It drops 22 cases that are repeat Russian interventions with the same target-year.
```{r}
# Subset
df <- df %>% dplyr::select(target, year_start, dplyr::starts_with("resp_")) %>%
    dplyr::rename(year = year_start) %>%
    dplyr::mutate(target = dplyr::recode(target, US = "United States", UK = "United Kingdom"))
df$target <- stringr::str_trim(df$target)

# Give ordinal value to each level
df$resp_convmil_gro <- df$resp_convmil_gro * 5
df$resp_convmil_airsea <- df$resp_convmil_airsea * 4
df$resp_paramil <- df$resp_paramil * 3
df$resp_cyberdisrup <- df$resp_cyberdisrup * 2
df$resp_infoops <- df$resp_infoops * 1

# Keep highest value per year
for( i in 1:nrow(df)){
  df$intensity[i] <- max(df$resp_convmil_gro[i],
                         df$resp_convmil_airsea[i],
                         df$resp_paramil[i], 
                         df$resp_cyberdisrup[i], 
                         df$resp_infoops[i])
}

# Subset to the highest value for country
df <- df %>%
  dplyr::group_by(target, year) %>%
  dplyr::filter(intensity == max(intensity)) %>%
  dplyr::select(target, year, intensity) %>%
  dplyr::distinct()
```

Merge the cleaned gray zone data into the Europe country-year dataset
```{r}
# Add cow codes to gray zone data for merging
df$country_code_cow <- countrycode::countrycode(df$target, "country.name", "cown")
df$country_code_cow <- as.character(df$country_code_cow)

# country COW abbreviation
df$country_abbrev_cow <- countrycode::countrycode(df$country_code_cow, "cown", "cowc")

# continent
df$continent <- countrycode::countrycode(df$country_code_cow, 'cown', 'continent')

# We have to manually deal with Georgia, Chechnya, Kosovo, the Czech Republic and drop the non-European observations
## Georgia
df$continent[df$country == "Georgia"] <- "Europe"

## Chechnya
df$continent[df$country == "Chechnya"] <- "Europe"

## Kosovo
df$continent[df$country == "Kosovo"] <- "Europe"

## Czech Republic
df$continent[df$country == "Czech Republic"] <- "Europe"

## Drop Vatican City
df <- df %>%
  dplyr::filter(!country_abbrev_cow == "PAP")

# Merge
df <- df %>%
  dplyr::rename(country = target)

df <- dplyr::left_join(full, df)

# Set non-events as 0
df$intensity[is.na(df$intensity)] <- 0
```

# Rename vars
```{r}
df <- df %>%
  dplyr::rename(cname1 = country, cabbrev1 = country_abbrev_cow, ccode1 = country_code_cow) %>%
  dplyr::select(-continent) %>%
  dplyr::select(year, cname1, cabbrev1, ccode1, intensity)

df$ccode1 <- as.numeric(df$ccode1)
```

# Add variables
We add a battery of variables for the RHS of the model. SideB is always Russia, so we can hard-code that variable.
```{r}
# COW codes
df$cname2 <- "Russia"
df$cabbrev2 <- "RUS"
df$ccode2 <- 365
```

## Distance from US
This is the independent variable of interest, coding how far the target state is from the US as the geographic proxy for deterrence. We code capital to capital distance using the Gleditsch and Ward cshapes dataset.
```{r}
df_dist <- read.table(paste0(here::here(), '/inst/extdata/capdist.csv'), header = TRUE, sep = ",")

df_dist <- df_dist %>%
  dplyr::filter(numb == 2) %>%
  dplyr::select(numa, kmdist) %>%
  dplyr::rename(capdistkm_us = kmdist, ccode1 = numa)

df <- dplyr::left_join(df, df_dist)
```

## Distance from Russia
We code distance from Russia to control for Russian resolve using the same data as above.
```{r}
df_dist <- read.table(paste0(here::here(), '/inst/extdata/capdist.csv'), header = TRUE, sep = ",")

df_dist <- df_dist %>%
  dplyr::filter(numb == 365) %>%
  dplyr::select(numa, kmdist) %>%
  dplyr::rename(capdistkm_rus = kmdist, ccode1 = numa)

df <- dplyr::left_join(df, df_dist)

# Add manually for Russia
df$capdistkm_rus[df$cabbrev1 == "RUS"] <- 0
```

## NATO membership
We code NATO membership as a binary variable for each country-year
```{r}
nato <- googlesheets4::read_sheet(ss = "https://docs.google.com/spreadsheets/d/1YlMVTe6IjgxEheRjUzITq7zSMlI3DRUSrcpGK35gKUg/edit#gid=0",
                                  sheet = "nato_membership",
                                  col_types = "cnnnnnnnnnnnc")

nato <- nato %>%
  dplyr::select(state, join_nato_year) %>%
  dplyr::filter(!join_nato_year == "NA")

nato$ccode1 <- countrycode::countrycode(nato$state, "country.name", "cown")

nato <- nato %>%
  dplyr::select(-state)

df <- dplyr::left_join(df, nato)

df <- df %>%
  dplyr::mutate(nato_memb_duration = year - join_nato_year) %>%
  dplyr::mutate(nato_memb = ifelse(nato_memb_duration >= 0, 1, 0)) %>%
  dplyr::rename(NATOmem_MEM = nato_memb, NATOdur_MEM = nato_memb_duration, NATOjoined_MEM = join_nato_year)
```

## CINC scores
We code CINC scores to control for power disparity between the two actors. Constitent with conventional measures, we also code the ratio of the challenger's (Russia) material capabilities ot the sum of both states capabilities
```{r}
cinc <- read.csv(paste0(here::here(), '/inst/extdata/NMC_5_0.csv'))

cinc_ccode1 <- cinc %>% dplyr::select(ccode, year, cinc) %>%
  dplyr::rename(ccode1 = ccode, cinc1 = cinc)

df <- dplyr::left_join(df, cinc_ccode1)

cinc_ccode2 <- cinc %>% dplyr::select(ccode, year, cinc) %>%
  dplyr::rename(ccode2 = ccode, cinc2 = cinc)

df <- dplyr::left_join(df, cinc_ccode2)

df$cinc_ratio <- df$cinc2/(df$cinc1+df$cinc2)
```

## Regime type
We code polity scores to control for whether or not both sides are democracies. In alignment with Gartzke and Jo 2009, they are re-scales from -10-10 to 0-20 so allow for a multiplicative variable
```{r}
polity <- psData::PolityGet(vars = 'polity2', OutCountryID = 'cown')
polity$polity2_scaled <- polity$polity2 + 10

polity_ccode1 <- polity %>% dplyr::select(cown, year, polity2_scaled) %>%
  dplyr::rename(ccode1 = cown, polity1 = polity2_scaled)
df <- dplyr::left_join(df, polity_ccode1)

polity_ccode2 <- polity %>% dplyr::select(cown, year, polity2_scaled) %>%
  dplyr::rename(ccode2 = cown, polity2 = polity2_scaled)
df <- dplyr::left_join(df, polity_ccode2)

df$polity_intaxn <- df$polity1 * df$polity2
```

## Civil war
We use UCDP to code whether a country-year is involved in an intrastate war
```{r}
load(paste0(here::here(), "/inst/extdata/ucdp-prio-acd-201.RData"))
ucdp <- ucdp_prio_acd_201
ucdp <- ucdp %>% dplyr::select(gwno_a, year, type_of_conflict) %>%
  dplyr::rename(ccode1 = gwno_a) %>%
  dplyr::mutate(ccode1 = strsplit(as.character(ccode1), ",")) %>%
  tidyr::unnest(ccode1) %>%
  dplyr::filter(type_of_conflict == 3) %>%
  dplyr::mutate(civilwar = 1) %>%
  dplyr::select(-type_of_conflict)

ucdp$ccode1 <- as.numeric(stringr::str_trim(ucdp$ccode1))
ucdp <- ucdp %>% dplyr::distinct()
df <- dplyr::left_join(df, ucdp)
df$civilwar[is.na(df$civilwar)] <- 0
```

## Nuclear status
We code nuclear status of the target state using the coding from from Jo and Gartzke 2007
```{r}
df$nuclear1 <- 0
df$nuclear1[df$cname1 == "France" | 
            df$cname1 == "United Kingdom"] <- 1
```

## GDP
We code GDP of Russia and the target state using the World Bank's World Development Indicator (WDI) published in Graham and Tucker 2017.
```{r}
WDI::WDIsearch("6.0.GDP_usd", cache = new_wdi_cache)

ipe <- WDI::WDI(indicator = '6.0.GDP_usd',
                country = "all",
                start = 1990,
                end = 2018)

ipe$ccode1 <- countrycode::countrycode(ipe$iso2c, "iso2c", "cown")

ipe_ccode1 <- ipe %>%
  dplyr::rename(gdp_2005const = "6.0.GDP_usd") %>%
  dplyr::select(year, ccode1, gdp_2005const)


ipe_ccode1 <- ipe %>% dplyr::select(year, ccode, gdp_WDI_PW) %>%
  dplyr::rename(ccode1 = ccode, gdp1 = gdp_WDI_PW)

df <- dplyr::left_join(df, ipe_ccode1)

ipe_ccode2 <- ipe %>% dplyr::select(year, ccode, gdp_WDI_PW) %>%
  dplyr::rename(ccode2 = ccode, gdp2 = gdp_WDI_PW)

df <- dplyr::left_join(df, ipe_ccode2)
```

# Data Summary
That leaves us with a dataset where the unit of analysis is the country-year, the universe of cases is country-years that were the targets of Russian intervention from 1994-2017, and the dependent variable is the means of Russian intervention, coded as dummy variables for the 5 different forms of intervention.
```{r}
DT::datatable(df)
naniar::gg_miss_var(df)
ExPanDaR::prepare_missing_values_graph(df, ts_id = "year")
funModeling::plot_num(df)
```

# Save data
Save the final version of the data that is now prepped for modeling
```{r}
saveRDS(df, paste0(here::here(), "/data/","grayzone_model.rds"))
write.csv(df, paste0(here::here(), "/data/","grayzone_model.csv"))
```

# System info
This markdown file was last run and replicated on the following system
```{r}
Sys.info()
```
